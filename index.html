<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Listado de Invitados</title>
<style>
  :root{ --gold:#d4af37; --bg:#0d0d0d; --panel:#1a1a1a; --text:#f5f5f5; --muted:#9aa0a6; --ok:#0f7b3a; --err:#b00020; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
  header{position:sticky;top:0;z-index:20;background:#000;color:var(--gold);padding:12px 16px;text-align:center;font-weight:700;letter-spacing:.08em;box-shadow:0 2px 12px rgba(212,175,55,.3)}
  .status{font-size:12px;color:#ddd;margin-top:6px}
  .badge{font-size:12px;border:1px solid var(--gold);padding:3px 8px;border-radius:999px;color:var(--gold)}
  .error{position:sticky;top:64px;z-index:30;background:var(--err);color:#fff;padding:8px 12px;text-align:center;display:none}
  .wrap{max-width:1100px;margin:12px auto;padding:0 12px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;position:sticky;top:96px;z-index:9;padding:10px 0;background:linear-gradient(180deg,#000,transparent)}
  input[type="search"]{flex:1;font-size:18px;padding:12px 14px;border:2px solid var(--gold);border-radius:12px;background:#141414;color:var(--text)}
  button{border:1px solid var(--gold);background:#141414;color:var(--gold);padding:10px 12px;border-radius:12px;font-size:15px}
  .seg{display:flex;gap:6px}
  .seg button{border-color:#333;color:#ddd}
  .seg .active{border-color:var(--gold);color:var(--gold)}
  .stats{font-size:14px;color:var(--muted);margin:6px 2px 10px}
  table{width:100%;border-collapse:collapse;background:var(--panel);border-radius:14px;overflow:hidden}
  th,td{padding:12px 10px;border-bottom:1px solid #2a2a2a}
  th{background:var(--gold);color:#000;text-transform:uppercase;font-size:13px}
  tr:hover{background:#262626}
  tr.checked{background:rgba(15,123,58,.18)}
  tr.checked td{border-bottom-color:rgba(15,123,58,.35)}
  mark{background:rgba(212,175,55,.35);padding:0 2px;border-radius:4px}
  .empty{padding:18px;text-align:center;color:var(--muted)}
  .chk{display:flex;justify-content:center}
  .chk input{width:22px;height:22px}
  @media (max-width:520px){ table{font-size:16px} th:nth-child(1),td:nth-child(1){width:74px} th:nth-child(4),td:nth-child(4){width:88px} }
</style>
</head>
<body>
<header>
  LISTADO DE INVITADOS
  <div class="status">
    <span id="badge" class="badge"></span>
    · Estado: <span id="conn">Conectando…</span>
    · UID: <span id="uid">—</span>
  </div>
</header>
<div id="err" class="error"></div>

<div class="wrap">
  <div class="bar">
    <input id="q" type="search" placeholder="Buscar por nombre, apellido o mesa… (ej. Mansilla, Mesa 12)" autocomplete="off" inputmode="search" enterkeyhint="search">
    <button id="clear">Limpiar</button>
    <div class="seg" role="tablist" aria-label="Filtro de estado">
      <button id="flt-all"   class="active" aria-pressed="true">Todos</button>
      <button id="flt-pend"  aria-pressed="false">Pendientes</button>
      <button id="flt-in"    aria-pressed="false">Ingresados</button>
    </div>
  </div>

  <div class="stats" id="stats">Cargando…</div>

  <table id="t">
    <thead><tr><th>No.</th><th>Nombre</th><th>Mesa</th><th>Ingresó</th></tr></thead>
    <tbody id="tb"></tbody>
  </table>
  <div class="empty" id="empty" style="display:none">Sin resultados.</div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
/* ==== CONFIGURACIÓN CORRECTA DE TU APP ==== */
const firebaseConfig = {
  apiKey: "AIzaSyBQ_IMs0kUfiiYbL2CHDo50yZLcEySmfiE",
  authDomain: "graduaciones-2025erase.firebaseapp.com",
  projectId: "graduaciones-2025erase",
  storageBucket: "graduaciones-2025erase.appspot.com",  // ✅ corregido
  messagingSenderId: "815573193665",
  appId: "1:815573193665:web:a93ff248fe6a919acc1540",
  measurementId: "G-Q57SRPCRBS"
};
firebase.initializeApp(firebaseConfig);
firebase.firestore().enablePersistence().catch(()=>{});
const auth = firebase.auth();
const db   = firebase.firestore();

/* ==== Funciones ==== */
const strip = s => (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\p{L}\p{N}\s]/gu," ").replace(/\s+/g," ").trim();
function debounce(fn,ms=120){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function getParam(name){return new URLSearchParams(location.search).get(name);}
function showErr(msg){const e=document.getElementById("err"); e.textContent = msg; e.style.display='block'; console.error(msg);}

const EVENT_CODE = getParam("event") || "GRAD_JUNIO_2025";
document.getElementById("badge").textContent = `Evento: ${EVENT_CODE}`;

let DATA = [], FILTER = "all", CHECKED = {};
const tb = document.getElementById("tb"), stats = document.getElementById("stats");
const coll = () => db.collection("events").doc(EVENT_CODE).collection("checkins");

/* ==== Cargar CSV ==== */
async function loadCSV(url){
  const res = await fetch(url);
  const txt = await res.text();
  const lines = txt.replace(/\r/g,"").split("\n").filter(Boolean);
  const sep = lines[0].includes(";")?";":",";
  return lines.slice(1).map(l=>{
    const [No, Nombres, Mesa] = l.split(sep).map(s=>s?.trim());
    const id = String(No||"").trim() || strip(Nombres);
    return {No, Nombres, Mesa, id};
  });
}

/* ==== Escuchar en tiempo real ==== */
function listenRealtime(){
  coll().onSnapshot(snap=>{
    snap.docChanges().forEach(ch=>{
      const id = ch.doc.id;
      CHECKED[id] = ch.doc.data()?.checked === true;
    });
    render(DATA);
  }, err=>showErr(err.message));
}

/* ==== Render ==== */
function render(list){
  const q = document.getElementById("q").value.toLowerCase();
  let filtered = list.filter(r=>{
    if(!q) return true;
    const t = `${r.No} ${r.Nombres} ${r.Mesa}`.toLowerCase();
    return t.includes(q);
  });
  if(FILTER==="in") filtered = filtered.filter(r=>CHECKED[r.id]);
  if(FILTER==="pend") filtered = filtered.filter(r=>!CHECKED[r.id]);
  tb.innerHTML = filtered.map(r=>`
    <tr data-id="${r.id}" class="${CHECKED[r.id]?'checked':''}">
      <td>${r.No}</td><td>${r.Nombres}</td><td>${r.Mesa}</td>
      <td class="chk"><input type="checkbox" ${CHECKED[r.id]?'checked':''}></td>
    </tr>`).join("");
  const total = list.length, inCount = Object.values(CHECKED).filter(v=>v).length;
  stats.textContent = `Pendientes: ${total - inCount} | Ingresados: ${inCount} | Total: ${total}`;
}

/* ==== Marcar/Desmarcar ==== */
async function toggle(id){
  const ref = coll().doc(id);
  const newVal = !CHECKED[id];
  CHECKED[id] = newVal;
  render(DATA);
  await ref.set({ checked: newVal, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
}

/* ==== Listeners ==== */
tb.addEventListener("change", e=>{
  const tr = e.target.closest("tr");
  if(tr) toggle(tr.dataset.id);
});
document.getElementById("clear").onclick = ()=>{ document.getElementById("q").value=""; render(DATA); };
document.getElementById("flt-all").onclick = ()=>{FILTER="all"; render(DATA);};
document.getElementById("flt-pend").onclick = ()=>{FILTER="pend"; render(DATA);};
document.getElementById("flt-in").onclick = ()=>{FILTER="in"; render(DATA);};
document.getElementById("q").addEventListener("input", debounce(()=>render(DATA)));

/* ==== Inicio ==== */
(async()=>{
  try{ await auth.signInAnonymously(); }catch(e){ showErr("Error auth: "+e.message); return; }
  DATA = await loadCSV("invitados.csv");
  render(DATA);
  listenRealtime();
})();
</script>
</body>
</html>
