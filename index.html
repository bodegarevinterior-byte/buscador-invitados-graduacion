<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Listado de Invitados</title>
<style>
  :root{ --gold:#d4af37; --bg:#0d0d0d; --panel:#1a1a1a; --text:#f5f5f5; --muted:#9aa0a6; --ok:#0f7b3a; --err:#b00020; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
  header{position:sticky;top:0;z-index:20;background:#000;color:var(--gold);padding:12px 16px;text-align:center;font-weight:700;letter-spacing:.08em;box-shadow:0 2px 12px rgba(212,175,55,.3)}
  .status{font-size:12px;color:#ddd;margin-top:6px}
  .badge{font-size:12px;border:1px solid var(--gold);padding:3px 8px;border-radius:999px;color:var(--gold)}
  .error{position:sticky;top:64px;z-index:30;background:var(--err);color:#fff;padding:8px 12px;text-align:center;display:none}
  .wrap{max-width:1100px;margin:12px auto;padding:0 12px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;position:sticky;top:96px;z-index:9;padding:10px 0;background:linear-gradient(180deg,#000,transparent)}
  input[type="search"]{flex:1;font-size:18px;padding:12px 14px;border:2px solid var(--gold);border-radius:12px;background:#141414;color:var(--text)}
  button{border:1px solid var(--gold);background:#141414;color:var(--gold);padding:10px 12px;border-radius:12px;font-size:15px}
  .seg{display:flex;gap:6px}
  .seg button{border-color:#333;color:#ddd}
  .seg .active{border-color:var(--gold);color:var(--gold)}
  .stats{font-size:14px;color:var(--muted);margin:6px 2px 10px}
  table{width:100%;border-collapse:collapse;background:var(--panel);border-radius:14px;overflow:hidden}
  th,td{padding:12px 10px;border-bottom:1px solid #2a2a2a}
  th{background:var(--gold);color:#000;text-transform:uppercase;font-size:13px}
  tr:hover{background:#262626}
  tr.checked{background:rgba(15,123,58,.18)}
  tr.checked td{border-bottom-color:rgba(15,123,58,.35)}
  mark{background:rgba(212,175,55,.35);padding:0 2px;border-radius:4px}
  .empty{padding:18px;text-align:center;color:var(--muted)}
  .chk{display:flex;justify-content:center}
  .chk input{width:22px;height:22px}
  @media (max-width:520px){ table{font-size:16px} th:nth-child(1),td:nth-child(1){width:74px} th:nth-child(4),td:nth-child(4){width:88px} }
</style>
</head>
<body>
<header>
  LISTADO DE INVITADOS
  <div class="status">
    <span id="badge" class="badge"></span>
    · Estado: <span id="conn">Conectando…</span>
    · UID: <span id="uid">—</span>
  </div>
</header>
<div id="err" class="error"></div>

<div class="wrap">
  <div class="bar">
    <input id="q" type="search" placeholder="Buscar por nombre, apellido o mesa… (ej. Mansilla, Mesa 12)" autocomplete="off" inputmode="search" enterkeyhint="search">
    <button id="clear">Limpiar</button>
    <div class="seg" role="tablist" aria-label="Filtro de estado">
      <button id="flt-all"   class="active" aria-pressed="true">Todos</button>
      <button id="flt-pend"  aria-pressed="false">Pendientes</button>
      <button id="flt-in"    aria-pressed="false">Ingresados</button>
    </div>
  </div>

  <div class="stats" id="stats">Cargando…</div>

  <table id="t">
    <thead><tr><th>No.</th><th>Nombre</th><th>Mesa</th><th>Ingresó</th></tr></thead>
    <tbody id="tb"></tbody>
  </table>
  <div class="empty" id="empty" style="display:none">Sin resultados.</div>
</div>

<!-- SDKs compat (para usar en GitHub Pages sin bundler) -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
/* ==== TU CONFIG (graduaciones-2025erase) ==== */
const firebaseConfig = {
  apiKey: "AIzaSyBQ_IMs8KUfiYbL2ChD0s8yZLcEySmfie",
  authDomain: "graduaciones-2025erase.firebaseapp.com",
  projectId: "graduaciones-2025erase",
  storageBucket: "graduaciones-2025erase.appspot.com",
  messagingSenderId: "815573193665",
  appId: "1:815573193665:web:a93ff248fe6a919acc1540",
  measurementId: "G-QS7SPRC8BS"
};
firebase.initializeApp(firebaseConfig);
firebase.firestore().enablePersistence().catch(()=>{});
const auth = firebase.auth();
const db   = firebase.firestore();

/* ==== Helpers ==== */
const strip = s => (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\p{L}\p{N}\s]/gu," ").replace(/\s+/g," ").trim();
function levenshtein(a,b){a=strip(a);b=strip(b);const m=Array.from({length:a.length+1},(_,i)=>[i]);for(let j=1;j<=b.length;j++)m[0][j]=j;for(let i=1;i<=a.length;i++)for(let j=1;j<=b.length;j++)m[i][j]=a[i-1]==b[j-1]?m[i-1][j-1]:1+Math.min(m[i-1][j],m[i][j-1],m[i-1][j-1]);return m[a.length][b.length];}
function highlight(text,q){if(!q)return text;const pat=strip(q).split(" ").filter(Boolean).join("|");if(!pat)return text;const re=new RegExp(`(${pat})`,"gi");return text.replace(re,m=>`<mark>${m}</mark>`);}
function debounce(fn,ms=120){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function getParam(name){return new URLSearchParams(location.search).get(name);}
function showErr(msg){const e=document.getElementById("err"); e.textContent = msg; e.style.display='block'; console.error(msg);}

/* ==== Evento por URL ==== */
const EVENT_CODE = getParam("event") || "GRAD_JUNIO_2025";
document.getElementById("badge").textContent = `Evento: ${EVENT_CODE}`;

/* ==== Estado ==== */
let DATA = [], FILTER = "all", CHECKED = {};
const tb = document.getElementById("tb");
const stats = document.getElementById("stats");
const statusEl = document.getElementById("conn");
const uidEl = document.getElementById("uid");
const coll = () => db.collection("events").doc(EVENT_CODE).collection("checkins");

/* ==== CSV ==== */
async function loadCSV(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error("No se pudo cargar invitados.csv");
  const txt = await res.text();
  const lines = txt.replace(/\r/g,"").split("\n").filter(Boolean);
  const sep = lines[0].includes(";")?";":",";
  return lines.slice(1).map(l=>{
    const [No, Nombres, Mesa] = l.split(sep).map(s=>s?.trim());
    const id = String(No||"").trim() || strip(Nombres);
    return {No, Nombres, Mesa, id};
  });
}

/* ==== Tiempo real ==== */
function listenRealtime(){
  coll().onSnapshot(
    (snap)=>{
      snap.docChanges().forEach(ch=>{
        const id = ch.doc.id;
        CHECKED[id] = ch.doc.data()?.checked === true;
      });
      search(document.getElementById("q").value);
    },
    (err)=> showErr(`Error escuchando Firestore: ${err.message}`)
  );
}

/* ==== Render ==== */
function counters(list){
  const total = DATA.length;
  const ingresados = Object.values(CHECKED).filter(v=>v).length;
  const visibles = list.length;
  const pendientes = total - ingresados;
  stats.textContent = `Pendientes: ${pendientes}  |  Ingresados: ${ingresados}  |  Total: ${total}  —  (Mostrando: ${visibles})`;
}
function rowHTML(r,q){
  const checked = !!CHECKED[r.id];
  return `
    <tr data-id="${r.id}" class="${checked?'checked':''}">
      <td>${highlight(String(r.No||""), q)}</td>
      <td>${highlight(r.Nombres||"", q)}</td>
      <td>${highlight(r.Mesa||"", q)}</td>
      <td class="chk"><input type="checkbox" ${checked?'checked':''} aria-label="Marcar ingreso de ${r.Nombres}"></td>
    </tr>`;
}
function render(list,q=""){ tb.innerHTML = list.map(r=>rowHTML(r,q)).join(""); counters(list); }

/* ==== Búsqueda + Filtro ==== */
function scoreRow(row, q){
  const qn = strip(q);
  const hay = strip(`${row.No} ${row.Nombres} ${row.Mesa}`);
  if(hay.includes(qn)) return 0;
  return Math.min(...hay.split(" ").map(t=>levenshtein(t, qn)));
}
function applyFilter(base){
  if(FILTER==="in")   return base.filter(r=>CHECKED[r.id]);
  if(FILTER==="pend") return base.filter(r=>!CHECKED[r.id]);
  return base;
}
function search(q){
  let list = DATA;
  if(q){
    const qn = strip(q);
    list = DATA.map(r=>({r, s: scoreRow(r,q)}))
      .filter(x=> strip(`${x.r.No} ${x.r.Nombres} ${x.r.Mesa}`).includes(qn) || x.s <= Math.max(1, Math.floor(qn.length*0.35)))
      .sort((a,b)=>a.s-b.s).map(x=>x.r);
  }
  list = applyFilter(list);
  render(list, q);
  document.getElementById("empty").style.display = list.length? "none":"block";
}

/* ==== Marcar / desmarcar ==== */
async function toggleById(id){
  const ref = coll().doc(id);
  const newVal = !CHECKED[id];
  CHECKED[id] = newVal; // optimista
  search(document.getElementById("q").value);
  try{
    await ref.set({ checked:newVal, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
  }catch(e){ showErr(`No se pudo guardar en Firestore: ${e.message}`); }
}
tb.addEventListener("change", e=>{
  if(e.target.matches('input[type="checkbox"]')){ const tr = e.target.closest("tr"); if(tr) toggleById(tr.dataset.id); }
});
tb.addEventListener("click", e=>{
  const tr = e.target.closest("tr");
  if(!tr || e.target.tagName.toLowerCase()==="input") return;
  toggleById(tr.dataset.id);
});

/* ==== Filtros y UI ==== */
const q = document.getElementById("q");
document.getElementById("clear").addEventListener("click", ()=>{ q.value=""; search(""); q.focus(); });
function setFilter(which){
  FILTER = which;
  document.getElementById("flt-all").classList.toggle("active", which==="all");
  document.getElementById("flt-pend").classList.toggle("active", which==="pend");
  document.getElementById("flt-in").classList.toggle("active", which==="in");
  search(q.value);
}
document.getElementById("flt-all").onclick = ()=>setFilter("all");
document.getElementById("flt-pend").onclick = ()=>setFilter("pend");
document.getElementById("flt-in").onclick = ()=>setFilter("in");
q.addEventListener("input", debounce(()=>search(q.value)));

/* ==== Inicio ==== */
(async ()=>{
  try{
    document.getElementById("conn").textContent = "Autenticando…";
    const cred = await auth.signInAnonymously();
    document.getElementById("uid").textContent = cred.user?.uid || "—";
    document.getElementById("conn").textContent = "Autenticado";
  }catch(e){ showErr(`Error de autenticación (¿Anónimo activado?): ${e.message}`); return; }
  try{ DATA = await loadCSV("invitados.csv"); render(DATA); }catch(e){ showErr("No se pudo cargar invitados.csv"); }
  listenRealtime();
  function updNet(){ document.getElementById("conn").textContent = navigator.onLine ? "Online" : "Offline"; }
  window.addEventListener('online', updNet); window.addEventListener('offline', updNet); updNet();
})();
</script>
</body>
</html>
